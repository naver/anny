version: "3.9"

services:
  anny-minimal:
    container_name: anny-minimal
    build:
      context: .
      target: minimal
    ports:
      - "7860:7860"
    environment:
      GRADIO_SERVER_NAME: "0.0.0.0"
      GRADIO_SERVER_PORT: "7860"
      OMP_NUM_THREADS: "2"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:7860/ || exit 1"]
      interval: 30s        # check every 30 seconds
      timeout: 10s         # wait up to 10 seconds per check
      start_period: 180s   # give Anny 3 minutes to load first
      retries: 5           # retry 5 times before marking unhealthy


  anny-full:
    container_name: anny-full
    build:
      context: .
      target: full             # uses the GPU + warp stage from Dockerfile
    ports:
      - "7860:7860"
    environment:
      GRADIO_SERVER_NAME: "0.0.0.0"
      GRADIO_SERVER_PORT: "7860"
    # For Docker Compose v2+, this enables GPU access (requires nvidia-container-toolkit)
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: ["gpu"]
    # If your Compose doesn't honor 'deploy' locally, uncomment one of the two lines below:
    # gpus: all                      # (Compose v2.3+)
    # runtime: nvidia                # (older Docker setups)
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:7860/ || exit 1"]
      interval: 30s
      timeout: 5s
      start_period: 180s
      retries: 3

